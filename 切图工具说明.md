# 图集切图工具使用说明

## 功能介绍

根据 plist 文件信息，将图集图片切分为单独的小图片。

- ✅ 支持标准 plist 格式
- ✅ 支持旋转的帧（rotated frames）
- ✅ 自动创建输出目录
- ✅ 支持批量处理
- ✅ 高性能图片处理（使用 sharp 库）

## 安装依赖

首次使用需要安装依赖：

```bash
npm install
# 或
npm install sharp xml2js
```

## 使用方法

### 方法 1：命令行 - 切割单个图集

```bash
# 基础用法（输出到图片同名目录）
ts-node slice-atlas.ts <图片路径> <plist路径>

# 指定输出目录
ts-node slice-atlas.ts <图片路径> <plist路径> <输出目录>
```

**示例：**

```bash
# 输出到 hetu 目录下
ts-node slice-atlas.ts "D:\work\test\fnt\assets\resources\pic\hetu.png" "D:\work\test\fnt\assets\resources\pic\hetu.plist"

# 指定输出目录
ts-node slice-atlas.ts "D:\work\test\fnt\assets\resources\pic\hetu.png" "D:\work\test\fnt\assets\resources\pic\hetu.plist" "D:\output\frames"
```

### 方法 2：命令行 - 批量处理目录

```bash
# 批量处理目录下所有图集
ts-node slice-atlas.ts <目录路径> --batch
```

**示例：**

```bash
ts-node slice-atlas.ts "D:\work\test\fnt\assets\resources\pic" --batch
```

批量模式会：
1. 自动查找目录下所有 `.plist` 文件
2. 查找对应的图片文件（.png、.jpg、.jpeg）
3. 为每个图集创建独立的输出目录

### 方法 3：在代码中调用

```typescript
import { sliceAtlas, sliceAtlasDirectory } from './slice-atlas';

// 切割单个图集
await sliceAtlas(
    'path/to/image.png',
    'path/to/image.plist',
    'path/to/output' // 可选
);

// 批量切割目录
await sliceAtlasDirectory('path/to/directory');
```

## 输出结果

### 目录结构

```
原图片目录/
├── hetu.png              # 原图集
├── hetu.plist            # plist 文件
└── hetu/                 # 自动创建的输出目录
    ├── Game-70_100%.png
    ├── Game-70_100EXTRA.png
    ├── Game-70_200%.png
    ├── Game-70_50%.png
    └── Game-70_Text_Amazing.png
```

### 控制台输出示例

```
Reading plist: D:\work\test\fnt\assets\resources\pic\hetu.plist
Found 5 frames
Loading image: D:\work\test\fnt\assets\resources\pic\hetu.png
Image size: 319x131
Output directory: D:\work\test\fnt\assets\resources\pic\hetu

✓ Game-70_100%.png (80x31)
✓ Game-70_100EXTRA.png (81x81)
✓ Game-70_200%.png (86x31)
✓ Game-70_50%.png (72x32)
✓ Game-70_Text_Amazing.png (269x50)

=== Slicing Complete ===
Success: 5/5
Output: D:\work\test\fnt\assets\resources\pic\hetu
```

## 完整工作流程

### 场景 1：从 Cocos JSON 到切图

```bash
# 步骤 1: 将 JSON 转换为 plist
ts-node json-to-plist-converter.ts input.json output.plist

# 步骤 2: 切割图集
ts-node slice-atlas.ts texture.png output.plist
```

### 场景 2：批量处理多个图集

```bash
# 假设你有一个包含多个图集的目录
# assets/
#   ├── atlas1.png
#   ├── atlas1.plist
#   ├── atlas2.png
#   └── atlas2.plist

ts-node slice-atlas.ts assets --batch
```

结果：
```
assets/
├── atlas1/           # 切出来的图片
│   ├── sprite1.png
│   └── sprite2.png
├── atlas2/           # 切出来的图片
│   ├── sprite3.png
│   └── sprite4.png
├── atlas1.png
├── atlas1.plist
├── atlas2.png
└── atlas2.plist
```

## 高级功能

### 处理旋转的帧

脚本会自动检测 plist 中的 `textureRotated` 标记，并正确处理旋转的帧。

### 处理偏移和原始尺寸

脚本会读取以下信息：
- `textureRect`: 在图集中的位置和尺寸
- `spriteOffset`: 精灵偏移
- `spriteSourceSize`: 原始尺寸
- `textureRotated`: 是否旋转

## 技术细节

### 支持的图片格式

- 输入：PNG, JPG, JPEG
- 输出：PNG（保持透明度）

### 性能

使用 `sharp` 库进行图片处理，性能优异：
- 处理单个图集：通常 < 1 秒
- 批量处理多个图集：并行处理，速度快

### 错误处理

- 自动跳过无效的帧
- 报告处理失败的帧
- 继续处理其他帧

## 常见问题

### Q: 需要安装什么依赖？

A: 运行 `npm install` 安装 `sharp` 和 `xml2js`。

### Q: 切出来的图片在哪里？

A: 默认在原图片同目录下，创建一个与图片同名的文件夹。例如 `hetu.png` 的切图会在 `hetu/` 目录下。

### Q: 支持批量处理吗？

A: 支持。使用 `--batch` 参数可以批量处理目录下所有图集。

### Q: 处理旋转的帧吗？

A: 是的，脚本会自动检测并处理旋转的帧（逆时针旋转 90 度复原）。

### Q: 可以指定输出目录吗？

A: 可以，命令行第三个参数即为输出目录。

### Q: Windows 路径怎么写？

A: 使用双反斜杠或正斜杠：
```bash
"D:\\path\\to\\file.png"  # 双反斜杠
"D:/path/to/file.png"     # 正斜杠（推荐）
```

## 实际应用示例

### 示例 1：游戏资源导出

```bash
# 假设你从 Cocos Creator 导出了资源
cd game-export/resources

# 批量切割所有图集
ts-node ../../slice-atlas.ts . --batch
```

### 示例 2：单个 UI 图集处理

```bash
# 处理单个 UI 图集
ts-node slice-atlas.ts ui_main.png ui_main.plist

# 切出来的图片在 ui_main/ 目录下
# 可以直接用于 UI 制作或其他工具
```

### 示例 3：整合到构建流程

```typescript
// build-script.ts
import { sliceAtlasDirectory } from './slice-atlas';

async function postBuild() {
    console.log('Slicing atlases...');
    await sliceAtlasDirectory('./build/assets/textures');
    console.log('Done!');
}

postBuild();
```

## npm 脚本快捷方式

在 `package.json` 中已配置快捷命令：

```bash
# 使用 npm 脚本
npm run slice <图片路径> <plist路径>
```

## 故障排除

### 错误：sharp 安装失败

```bash
# 清除缓存重新安装
npm cache clean --force
npm install sharp --save
```

### 错误：找不到图片文件

检查：
1. 图片路径是否正确
2. 文件是否存在
3. 文件扩展名是否正确

### 错误：plist 解析失败

检查：
1. plist 文件格式是否正确
2. 是否是标准的 Apple Property List XML 格式

## 相关工具

- `json-to-plist-converter.ts` - 将 Cocos JSON 转换为 plist
- `slice-atlas.ts` - 本工具，切割图集
- `dealRes.ts` - 资源处理工具

## 更新日志

- v1.0.0 - 初始版本
  - 支持基础切图功能
  - 支持批量处理
  - 支持旋转帧处理
