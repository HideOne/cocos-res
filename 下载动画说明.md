# 下载全屏加载动画说明

## 功能描述

点击"下载结果"按钮时，会显示一个全屏的转圈等待动画，提供更好的用户体验反馈。

## 实现内容

### 1. HTML 结构 (`static/index.html`)

添加了全屏加载动画容器：

```html
<div id="fullscreenLoader" class="fullscreen-loader">
    <div class="loader-content">
        <div class="spinner"></div>
        <p class="loader-text">正在准备下载...</p>
        <p class="loader-hint">请稍候，文件正在打包中</p>
    </div>
</div>
```

### 2. CSS 样式 (`static/style.css`)

**全屏遮罩层**
- 黑色半透明背景 (85% 不透明度)
- 毛玻璃效果 (backdrop-filter: blur)
- 层级最高 (z-index: 10000)

**转圈动画**
- 80x80 像素的圆形加载指示器
- 蓝色顶部边框旋转效果
- 每秒旋转一圈

**文字提示**
- 主标题：24px 白色粗体
- 副标题：16px 半透明白色

### 3. JavaScript 逻辑 (`static/app.js`)

#### 全局函数

```javascript
// 显示加载动画
showFullscreenLoader(text, hint)

// 隐藏加载动画
hideFullscreenLoader()
```

#### 下载流程

```javascript
async downloadResult(taskId) {
    // 1. 显示加载动画
    showFullscreenLoader('正在准备下载...', '请稍候，文件正在打包中');
    
    // 2. 检查任务状态
    const checkResponse = await fetch(...)
    
    // 3. 使用隐藏iframe进行下载
    const iframe = document.createElement('iframe');
    iframe.src = downloadUrl;
    
    // 4. 3秒后隐藏加载动画
    setTimeout(() => {
        hideFullscreenLoader();
    }, 3000);
}
```

## 工作流程

```
用户点击"📥 下载结果"
   ↓
显示全屏加载动画
   ↓
检查任务状态
   ↓
创建隐藏iframe
   ↓
开始下载
   ↓
3秒后隐藏动画
   ↓
清理iframe
```

## 视觉效果

### 加载动画
- **背景**: 黑色半透明 + 毛玻璃效果
- **转圈**: 蓝色旋转圆环 (80px)
- **文字**: 
  - "正在准备下载..." (大标题)
  - "请稍候，文件正在打包中" (副标题)

### 动画时长
- 淡入: 0.3 秒
- 显示: 3 秒
- 自动隐藏

## 技术细节

### 为什么使用 iframe？

使用隐藏的 iframe 而不是 `window.location.href` 的原因：

1. **不刷新页面**: iframe 下载不会影响当前页面
2. **可控制时机**: 可以在下载开始后隐藏动画
3. **用户体验**: 页面保持稳定，不会跳转

### 延迟设置

```javascript
setTimeout(() => {
    hideFullscreenLoader();
}, 3000);  // 3秒后隐藏
```

- **3秒**: 给服务器足够时间准备ZIP文件
- **可调整**: 根据实际情况修改延迟时间

### 清理机制

```javascript
setTimeout(() => {
    document.body.removeChild(iframe);
}, 5000);  // 5秒后清理iframe
```

确保不会造成内存泄漏。

## 使用场景

### 场景 1: 小文件下载
- 显示动画 3 秒
- 下载迅速开始
- 用户看到反馈

### 场景 2: 大文件下载
- 显示动画 3 秒
- 服务器准备时间较长
- 浏览器下载进度条接管

### 场景 3: 下载失败
- 显示动画
- 捕获错误
- 立即隐藏动画
- 显示错误提示

## 自定义文本

可以在调用时自定义显示文本：

```javascript
// 默认文本
showFullscreenLoader('正在准备下载...', '请稍候，文件正在打包中');

// 自定义文本
showFullscreenLoader('正在处理...', '大文件可能需要较长时间');
showFullscreenLoader('正在压缩...', '压缩完成后将自动下载');
```

## 兼容性

- ✅ Chrome/Edge (现代浏览器)
- ✅ Firefox
- ✅ Safari
- ✅ 移动端浏览器

**CSS 特性**:
- `backdrop-filter`: 毛玻璃效果 (可选)
- `animation`: 旋转动画 (必需)
- `fixed` 定位: 全屏显示 (必需)

## 优化建议

### 1. 根据文件大小调整时长

```javascript
const fileSize = getFileSize(taskId);
const duration = fileSize > 100 * 1024 * 1024 ? 5000 : 3000;

setTimeout(() => {
    hideFullscreenLoader();
}, duration);
```

### 2. 添加进度指示

```javascript
showFullscreenLoader('正在下载 35%', '预计剩余 10 秒');
```

### 3. 取消下载

添加取消按钮：

```html
<button onclick="cancelDownload()">取消下载</button>
```

## 故障排查

### 动画不显示
- 检查 `fullscreenLoader` 元素是否存在
- 检查 CSS 是否正确加载
- 检查 z-index 是否足够高

### 动画不消失
- 检查 `hideFullscreenLoader()` 是否被调用
- 检查 setTimeout 是否正常执行
- 手动调用 `hideFullscreenLoader()` 测试

### 下载不开始
- 检查服务器端点是否正常
- 检查 iframe 是否正确创建
- 检查浏览器控制台错误信息

---

**添加日期**: 2026-01-16  
**版本**: v1.0
